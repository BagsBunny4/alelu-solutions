<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Telegram CRM</title>
    <style>
        :root {
            --bg: #0b0f14;
            --bg-2: #0f151c;
            --panel: rgba(255, 255, 255, 0.06);
            --panel-strong: rgba(255, 255, 255, 0.10);
            --stroke: rgba(255, 255, 255, 0.08);
            --text: #e9eef3;
            --muted: #a6b2bf;
            --accent: #22d3ee;
            --accent-2: #60a5fa;
            --ok: #34d399;
            --warn: #f59e0b;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; }

        body {
            font-family: "Space Grotesk", "Rubik", "Segoe UI", sans-serif;
            background:
                radial-gradient(1200px 600px at 10% -10%, rgba(34,211,238,0.18), transparent 60%),
                radial-gradient(900px 600px at 90% 0%, rgba(96,165,250,0.18), transparent 60%),
                linear-gradient(180deg, #0a0f14 0%, #0b1118 100%);
            color: var(--text);
            margin: 0;
            min-height: 100vh;
        }

        .shell {
            max-width: 1100px;
            margin: 18px auto 40px;
            padding: 0 14px;
        }

        .hero {
            background: linear-gradient(135deg, rgba(34,211,238,0.08), rgba(96,165,250,0.08));
            border: 1px solid var(--stroke);
            border-radius: 18px;
            padding: 18px 18px 14px;
            position: relative;
            overflow: hidden;
        }

        .hero::after {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(500px 120px at 20% 0%, rgba(34,211,238,0.15), transparent 70%);
            pointer-events: none;
        }

        .title {
            font-size: 28px;
            margin: 0 0 6px;
            letter-spacing: 0.2px;
        }

        .meta {
            color: var(--muted);
            font-size: 13px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .pill {
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid var(--stroke);
            background: rgba(255,255,255,0.04);
            font-size: 12px;
        }

        .grid {
            margin-top: 14px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .panel {
            background: var(--panel);
            border: 1px solid var(--stroke);
            border-radius: 16px;
            padding: 12px;
            backdrop-filter: blur(10px);
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .btn {
            appearance: none;
            border: 1px solid var(--stroke);
            background: var(--panel-strong);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 13px;
            cursor: pointer;
            transition: transform 0.08s ease, border-color 0.2s ease, background 0.2s ease;
        }

        .btn:hover {
            border-color: rgba(96,165,250,0.5);
            background: rgba(96,165,250,0.12);
        }

        .btn.primary {
            border-color: rgba(34,211,238,0.6);
            background: linear-gradient(135deg, rgba(34,211,238,0.25), rgba(96,165,250,0.25));
        }

        .btn.danger {
            border-color: rgba(239,68,68,0.6);
            background: rgba(239,68,68,0.12);
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-top: 6px;
        }

        .tab {
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid var(--stroke);
            background: rgba(255,255,255,0.03);
            font-size: 12px;
            cursor: pointer;
        }

        .tab.active {
            border-color: rgba(34,211,238,0.6);
            color: var(--accent);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .table th, .table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--stroke);
            text-align: left;
            vertical-align: middle;
        }

        .table th {
            color: var(--muted);
            font-weight: 600;
            font-size: 12px;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid var(--stroke);
            font-size: 11px;
        }

        .status-new { color: var(--accent); }
        .status-work { color: var(--warn); }
        .status-done { color: var(--ok); }

        .row { margin: 10px 0; }
        .error { color: var(--danger); }
        .success { color: var(--ok); }

        .select {
            background: transparent;
            color: var(--text);
            border: 1px solid var(--stroke);
            border-radius: 8px;
            padding: 6px 8px;
            font-size: 12px;
        }

        @media (max-width: 700px) {
            .title { font-size: 24px; }
            .table th, .table td { font-size: 12px; }
        }
    </style>
</head>
<body>
    <div class="shell">
        <div class="hero">
            <h1 class="title">Telegram CRM</h1>
            <div class="meta">
                <span id="roleInfo">Роль: загрузка...</span>
            </div>
        </div>

        <div class="grid">
            <div class="panel">
                <div class="toolbar" id="adminActions" style="display:none;">
                    <button class="btn tab active" id="tabProjects" onclick="showTab('projects')">Проекты</button>
                    <button class="btn tab" id="tabClients" onclick="showTab('clients')">Клиенты</button>
                    <button class="btn primary" onclick="createInvite()">Пригласить разработчика</button>
                    <button class="btn danger" onclick="deactivateUser()">Деактивировать пользователя</button>
                </div>
                <div class="row error" id="errorBox" style="display:none;"></div>
                <div class="row success" id="successBox" style="display:none;"></div>
                <table id="projectsTable" class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Код</th>
                    <th>Статус</th>
                    <th>Группа</th>
                    <th>Клиент</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody id="projectsBody"></tbody>
        </table>
        <table id="clientsTable" class="table" style="display:none;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Имя</th>
                    <th>Username</th>
                    <th>Активен</th>
                    <th>Создан</th>
                </tr>
            </thead>
            <tbody id="clientsBody"></tbody>
        </table>
            </div>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const API_BASE_URL = "http://localhost:8000";
        const STATUS_LABELS = {
            "NEW_CLIENT": "новый клиент",
            "IN_PROGRESS": "в работе",
            "DONE": "сдан проект"
        };

        function showError(msg) {
            const el = document.getElementById("errorBox");
            el.style.display = "block";
            el.textContent = msg;
        }

        function showSuccess(msg) {
            const el = document.getElementById("successBox");
            el.style.display = "block";
            el.textContent = msg;
            setTimeout(() => { el.style.display = "none"; }, 2000);
        }

        async function api(path, data) {
            try {
                const res = await fetch(API_BASE_URL + path, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                return res.json();
            } catch (e) {
                showError("Не удалось подключиться к API. Проверь HTTPS и адрес API.");
                return { ok: false, error: "network_error" };
            }
        }

        async function loadProjects(role) {
            const initData = window.Telegram?.WebApp?.initData || "";
            const endpoint = role === "admin" ? "/api/admin/projects" : "/api/projects";
            const data = await api(endpoint, { initData });
            if (!data.ok) {
                showError(data.error || "Ошибка загрузки проектов");
                return;
            }
            renderProjects(data.projects || [], role);
        }

        async function loadClients() {
            const initData = window.Telegram?.WebApp?.initData || "";
            const data = await api("/api/admin/clients", { initData });
            if (!data.ok) {
                showError(data.error || "Ошибка загрузки клиентов");
                return;
            }
            renderClients(data.clients || []);
        }

        function renderProjects(projects, role) {
            const tbody = document.getElementById("projectsBody");
            tbody.innerHTML = "";
            if (!projects.length) {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td colspan="6">Пока нет проектов</td>`;
                tbody.appendChild(tr);
                return;
            }
            projects.forEach(p => {
                const statusClass = p.status === "NEW_CLIENT" ? "status-new" : (p.status === "IN_PROGRESS" ? "status-work" : "status-done");
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${p.project_id}</td>
                    <td>${p.proj_code || ""}</td>
                    <td><span class="badge ${statusClass}">${STATUS_LABELS[p.status] || p.status}</span></td>
                    <td>${p.group_title || ""}</td>
                    <td>${p.client_id || ""}</td>
                    <td class="actions"></td>
                `;
                const actions = tr.querySelector(".actions");
                if (role === "admin" || role === "developer") {
                    const sel = document.createElement("select");
                    sel.className = "select";
                    ["NEW_CLIENT","IN_PROGRESS","DONE"].forEach(s => {
                        const opt = document.createElement("option");
                        opt.value = s;
                        opt.textContent = STATUS_LABELS[s];
                        if (s === p.status) opt.selected = true;
                        sel.appendChild(opt);
                    });
                    const btn = document.createElement("button");
                    btn.className = "btn";
                    btn.textContent = "Сменить статус";
                    btn.onclick = async () => {
                        const initData = window.Telegram?.WebApp?.initData || "";
                        const res = await api("/api/projects/status", { initData, project_id: p.project_id, status: sel.value });
                        if (!res.ok) return showError(res.error || "Ошибка");
                        showSuccess("Статус обновлен");
                        loadProjects(role);
                    };
                    actions.appendChild(sel);
                    actions.appendChild(btn);
                }
                if (role === "admin") {
                    const archiveBtn = document.createElement("button");
                    archiveBtn.className = "btn";
                    archiveBtn.textContent = "Архивировать";
                    archiveBtn.onclick = async () => {
                        const initData = window.Telegram?.WebApp?.initData || "";
                        const res = await api("/api/admin/archive", { initData, project_id: p.project_id });
                        if (!res.ok) return showError(res.error || "Ошибка");
                        showSuccess("Проект архивирован");
                        loadProjects(role);
                    };
                    actions.appendChild(archiveBtn);
                }
                tbody.appendChild(tr);
            });
        }

        function renderClients(clients) {
            const tbody = document.getElementById("clientsBody");
            tbody.innerHTML = "";
            if (!clients.length) {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td colspan="5">Клиентов пока нет</td>`;
                tbody.appendChild(tr);
                return;
            }
            clients.forEach(c => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${c.user_id}</td>
                    <td>${c.first_name || ""}</td>
                    <td>${c.username ? "@" + c.username : ""}</td>
                    <td>${c.is_active ? "да" : "нет"}</td>
                    <td>${c.created_at || ""}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function showTab(tab) {
            document.getElementById("projectsTable").style.display = tab === "projects" ? "table" : "none";
            document.getElementById("clientsTable").style.display = tab === "clients" ? "table" : "none";
            const tp = document.getElementById("tabProjects");
            const tc = document.getElementById("tabClients");
            if (tp && tc) {
                tp.classList.toggle("active", tab === "projects");
                tc.classList.toggle("active", tab === "clients");
            }
            if (tab === "clients") {
                loadClients();
            }
        }

        async function createInvite() {
            const initData = window.Telegram?.WebApp?.initData || "";
            const res = await api("/api/admin/invite-dev", { initData });
            if (!res.ok) return showError(res.error || "Ошибка");
            showSuccess("Ссылка создана");
            alert("Ссылка для разработчика:\n" + res.link);
        }

        async function deactivateUser() {
            const userId = prompt("Введите user_id для деактивации:");
            if (!userId) return;
            const initData = window.Telegram?.WebApp?.initData || "";
            const res = await api("/api/admin/deactivate", { initData, user_id: Number(userId) });
            if (!res.ok) return showError(res.error || "Ошибка");
            showSuccess("Пользователь деактивирован");
        }

        async function init() {
            const tg = window.Telegram?.WebApp;
            if (!tg) {
                showError("WebApp не найден. Откройте страницу из Telegram.");
                return;
            }
            tg.ready();
            const initData = tg.initData || "";
            const auth = await api("/api/auth", { initData });
            if (!auth.ok) {
                showError(auth.error || "Ошибка авторизации");
                return;
            }
            document.getElementById("roleInfo").textContent = "Роль: " + auth.role;
            if (auth.role === "admin") {
                document.getElementById("adminActions").style.display = "block";
            }
            loadProjects(auth.role);
        }

        init();
    </script>
</body>
</html>
