<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Telegram CRM</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f7f7f7;
            color: #222;
            margin: 0;
        }
        .container {
            max-width: 900px;
            margin: 20px auto;
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 6px rgba(0,0,0,0.08);
        }
        h1 { margin: 0 0 12px; }
        .meta { color: #666; margin-bottom: 12px; }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border-bottom: 1px solid #eee;
            text-align: left;
            padding: 8px;
            font-size: 14px;
        }
        th { background: #fafafa; }
        .actions button, .actions select {
            margin-right: 6px;
        }
        .row { margin: 10px 0; }
        .error { color: #b00020; }
        .success { color: #006400; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Telegram CRM</h1>
        <div class="meta" id="roleInfo">Роль: ...</div>
        <div class="row actions" id="adminActions" style="display:none;">
            <button onclick="createInvite()">Пригласить разработчика</button>
            <button onclick="deactivateUser()">Деактивировать пользователя</button>
        </div>
        <div class="row error" id="errorBox" style="display:none;"></div>
        <div class="row success" id="successBox" style="display:none;"></div>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Код</th>
                    <th>Статус</th>
                    <th>Группа</th>
                    <th>Клиент</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody id="projectsBody"></tbody>
        </table>
    </div>

    <script>
        const API_BASE_URL = "http://localhost:8000";
        const STATUS_LABELS = {
            "NEW_CLIENT": "новый клиент",
            "IN_PROGRESS": "в работе",
            "DONE": "сдан проект"
        };

        function showError(msg) {
            const el = document.getElementById("errorBox");
            el.style.display = "block";
            el.textContent = msg;
        }

        function showSuccess(msg) {
            const el = document.getElementById("successBox");
            el.style.display = "block";
            el.textContent = msg;
            setTimeout(() => { el.style.display = "none"; }, 2000);
        }

        async function api(path, data) {
            const res = await fetch(API_BASE_URL + path, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
            return res.json();
        }

        async function loadProjects(role) {
            const initData = window.Telegram?.WebApp?.initData || "";
            const endpoint = role === "admin" ? "/api/admin/projects" : "/api/projects";
            const data = await api(endpoint, { initData });
            if (!data.ok) {
                showError(data.error || "Ошибка загрузки проектов");
                return;
            }
            renderProjects(data.projects || [], role);
        }

        function renderProjects(projects, role) {
            const tbody = document.getElementById("projectsBody");
            tbody.innerHTML = "";
            projects.forEach(p => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${p.project_id}</td>
                    <td>${p.proj_code || ""}</td>
                    <td>${STATUS_LABELS[p.status] || p.status}</td>
                    <td>${p.group_title || ""}</td>
                    <td>${p.client_id || ""}</td>
                    <td class="actions"></td>
                `;
                const actions = tr.querySelector(".actions");
                if (role === "admin" || role === "developer") {
                    const sel = document.createElement("select");
                    ["NEW_CLIENT","IN_PROGRESS","DONE"].forEach(s => {
                        const opt = document.createElement("option");
                        opt.value = s;
                        opt.textContent = STATUS_LABELS[s];
                        if (s === p.status) opt.selected = true;
                        sel.appendChild(opt);
                    });
                    const btn = document.createElement("button");
                    btn.textContent = "Сменить статус";
                    btn.onclick = async () => {
                        const initData = window.Telegram?.WebApp?.initData || "";
                        const res = await api("/api/projects/status", { initData, project_id: p.project_id, status: sel.value });
                        if (!res.ok) return showError(res.error || "Ошибка");
                        showSuccess("Статус обновлен");
                        loadProjects(role);
                    };
                    actions.appendChild(sel);
                    actions.appendChild(btn);
                }
                if (role === "admin") {
                    const archiveBtn = document.createElement("button");
                    archiveBtn.textContent = "Архивировать";
                    archiveBtn.onclick = async () => {
                        const initData = window.Telegram?.WebApp?.initData || "";
                        const res = await api("/api/admin/archive", { initData, project_id: p.project_id });
                        if (!res.ok) return showError(res.error || "Ошибка");
                        showSuccess("Проект архивирован");
                        loadProjects(role);
                    };
                    actions.appendChild(archiveBtn);
                }
                tbody.appendChild(tr);
            });
        }

        async function createInvite() {
            const initData = window.Telegram?.WebApp?.initData || "";
            const res = await api("/api/admin/invite-dev", { initData });
            if (!res.ok) return showError(res.error || "Ошибка");
            showSuccess("Ссылка создана");
            alert("Ссылка для разработчика:\n" + res.link);
        }

        async function deactivateUser() {
            const userId = prompt("Введите user_id для деактивации:");
            if (!userId) return;
            const initData = window.Telegram?.WebApp?.initData || "";
            const res = await api("/api/admin/deactivate", { initData, user_id: Number(userId) });
            if (!res.ok) return showError(res.error || "Ошибка");
            showSuccess("Пользователь деактивирован");
        }

        async function init() {
            const initData = window.Telegram?.WebApp?.initData || "";
            const auth = await api("/api/auth", { initData });
            if (!auth.ok) {
                showError(auth.error || "Ошибка авторизации");
                return;
            }
            document.getElementById("roleInfo").textContent = "Роль: " + auth.role;
            if (auth.role === "admin") {
                document.getElementById("adminActions").style.display = "block";
            }
            loadProjects(auth.role);
        }

        init();
    </script>
</body>
</html>
